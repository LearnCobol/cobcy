/* seminit.cc
**
**	Implements initialization actions for COBOL compiler.
*/

#ifdef __MSDOS__
#include "semexter.h"
#include "semcontr.h"
#else
#include "semextern.h"
#include "semcontrol.h"
#endif
#include "semdecl.h"
#include "semscreen.h"
#include "semfile.h"
#include "symfile.h"
#include "symvar.h"

/*--------------------------------------------------*/
  ofstream 			codef;
  ofstream 			declf;
  Stack<StackEntry> 		SemStack;
  HashTable<CobolSymbol> 	SymTable;
  int 				NestingLevel = 0;
  BOOL				CodeBegan = FALSE;
/*--------------------------------------------------*/

void FinishDecl (void)
{
#ifndef NDEBUG
    cout << "DBG: Finishing declarations\n";
#endif
    CloseScopeLevels (0);
    CloseScreenSection();
    AssociateRecordsWithFD();
    codef << "\n";
}

void StartCode (void)
{
    FinishDecl();
#ifndef NDEBUG
    cout << "DBG: Starting code, initializing variables\n";
#endif
    InitializeVariables();

#ifndef NDEBUG
    cout << "DBG: Beginning first paragraph\n";
#endif
    GenIndent();
    codef << "static int _FirstParagraph (void)\n";
    codef << "{\n";
    ++ NestingLevel;

    CodeBegan = TRUE;
}

void EndCode (void)
{
    if (!SemStack.IsEmpty())
	WriteError ("leftover stack entries");
#ifndef NDEBUG
    cout << "DBG: Finished code, generating main()\n";
#endif
    codef << "\n";
    codef << "void _CallParagraphSequence (long int _startCpi, long int _endCpi)\n";
    codef << "{\n";
    ++ NestingLevel;
    codef << "long int _cpi = 0;\n";
    codef << "\n";
    GenParagraphCalls();
    -- NestingLevel;
    codef << "}\n";
    codef << "\n";
    codef << "int main ()\n";
    codef << "{\n";
    ++ NestingLevel;

    if (CobcyConfig.UseCurses && GetCursesUsed()) {
	GenIndent(); codef << "_EnableCurses();\n";
	GenIndent(); codef << "initscr();\n";
	GenIndent(); codef << "if (has_colors())\n";
	GenIndent(); GenIndent(); codef << "start_color();\n";
	GenIndent(); codef << "echo(); nocbreak(); noraw();\n";
    }
    GenIndent();
    codef << "_SetVarValues();\n";
    OpenSpecialFiles();		// Generates code if there are any
    GenIndent();
    codef << "_CallParagraphSequence (_pi__FirstParagraph, -1);\n";
    CloseSpecialFiles();
    if (CobcyConfig.UseCurses && GetCursesUsed()) {
	GenIndent();
	codef << "endwin();\n";
    }
    GenIndent();
    codef << "return (0);\n";
    -- NestingLevel;
    GenIndent();
    codef << "}\n";
}

void StartProgram (void)
{
CobolVar * NewSymbol;
CobolFile * NewFile;

    codef.open (CobcyConfig.CodeFile);
    declf.open (CobcyConfig.DeclFile);

    codef << "/* " << (char*) CobcyConfig.CodeFile << "\n";
    codef << "**\n**\tGenerated by Cobol-to-C compiler from ";
    codef << (char*) CobcyConfig.SourceFile << ".\n";
    codef << "*/\n\n";

    declf << "/* " << (char*) CobcyConfig.DeclFile << "\n";
    declf << "**\n**\tGenerated by Cobol-to-C compiler from ";
    declf << (char*) CobcyConfig.SourceFile << ".\n";
    declf << "*/\n\n";


    codef << "#include <stdio.h>\n";	// For files and IO
    codef << "#include <string.h>\n";	// For memset
    codef << "#include <cobfunc.h>\n";	// For internal functions
    if (CobcyConfig.UseCurses)
	codef << "#include <ncurses.h>\n";  // For AT in DISPLAY and ACCEPT

    // This is the file for forward function declarations, their indices, etc.
    codef << "#include \"" << CobcyConfig.DeclFile << "\"\n\n";

    codef << "static char _space_var [201];\n";
    codef << "static long int _zero_var = 0;\n";
    codef << "static long int _index = 0;\n";	// Loop iterator
    codef << "\n";
    codef << "static void _CallParagraphSequence (long int _startCpi, long int _endCpi);\n";
    codef << "\n";

    // This is Current Paragraph Index
    SymTable.Clear();

    // Space filler variable
    NewSymbol = new CobolVar;
    NewSymbol->SetPicture ("x(200)");
    NewSymbol->SetName ("_space_var");
#ifndef NDEBUG
    cout << "DBG: Declaring _space_var\n";
#endif
    SymTable.Insert ("_space_var", NewSymbol);

    // Zero filler variable
    NewSymbol = new CobolVar;
    NewSymbol->SetPicture ("9(1)");
    NewSymbol->SetName ("_zero_var");
#ifndef NDEBUG
    cout << "DBG: Declaring _zero_var\n";
#endif
    SymTable.Insert ("_zero_var", NewSymbol);

    // Default output stream
    NewFile = new CobolFile;
    NewFile->SetName ("stdout");
    NewFile->SetOrganization (ORG_Sequential);
    NewFile->SetAccessMode (AM_Sequential);
#ifndef NDEBUG
    cout << "DBG: Declaring stdout\n";
#endif
    SymTable.Insert ("stdout", NewFile);
}

void EndProgram (void)
{
    codef.close();
    declf.close();
}

